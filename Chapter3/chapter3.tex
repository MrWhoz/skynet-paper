% **************************** Define Graphics Path **************************
\ifpdf
\graphicspath{{Chapter3/Figs/Raster/}{Chapter3/Figs/PDF/}{Chapter3/Figs/}{Chapter3/Figs/Web/}{Chapter3/Figs/Server/}{Chapter3/Figs/Mobile/}}
\else
\graphicspath{{Chapter3/Figs/Vector/}{Chapter3/Figs/}}
\fi

\chapter{Thiết kế và Hiện thực}

\section{Thiết kế hệ thống}
\subsection{Kiến trúc mô hình hệ thống}
\label{sec: struc}

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
\subsubsection*{Cách thức tương tác cập nhật dữ liệu}

Trong việc tương tác cập nhật dữ liệu, hiện nay mô hình truy thường được sử dụng là \textbf{polling}. Client và server phải liên tục gửi các request liên tục cách nhau trong một thời gian cố định để kiểm tra liệu có sự thay đổi cập nhật dữ liệu. 
\begin{figure}[H]
	\centering    
	\includegraphics[width=1.0\textwidth]{polling}
	\caption[Mô hình tương tác polling]{Mô hình tương tác polling}
	\label{fig: polling}
\end{figure}
Phương pháp này dễ hiện thực và áp dụng, tuy nhiên sẽ mắc nhược điểm là tốn nhiều gói tin request vô dụng làm giảm hiệu năng hệ thống, và không đáp ứng tính realtime nếu như chu kì gửi request dài.



Vì hiện tại nhóm chúng tôi đang hướng tới hướng phát triển IoT, đòi hỏi yêu cầu về tính realtime cũng như tối ưu hóa hệ thống. Và để đáp ứng yêu cầu đó, nhóm đã tìm tới giải pháp giữ socket kết nối từ \textbf{Database} (RethinkDB) <-> \textbf{Server} (Chạy trên nền tảng Nodejs) <-> \textbf{Client} (web browser)

\begin{figure}[H]
	\centering    
	\includegraphics[width=1.0\textwidth]{realtime}
	\caption[Mô hình tương tác realtime dựa trên Socket]{Mô hình tương tác realtime dựa trên Socket}
	\label{fig: realtime}
\end{figure}

Như hình \ref{fig: realtime}, mô hình hoạt động đơn giản hơn rất nhiều, giảm bớt số lượng request không đáng có và đảm bảo tính realtime cho hệ thống.

Một điểm mạnh ở mô hình này nữa là có thể phát triển nhiều server hoặc ứng dụng di động sử dụng chung một hệ quản lý cơ sở dữ liệu nhưng vẫn đảm bảo sự đồng bộ dữ liệu cập nhật tới enduser theo thời gian thực.
\begin{figure}[H]
	\centering    
	\includegraphics[width=1.0\textwidth]{multiserver}
	\caption[Mô hình tương tác cập nhật nhiều Server]{Mô hình tương tác cập nhật nhiều Server}
	\label{fig: multiserver}
\end{figure}
\subsection{Thiết kế API}
\label{sec: api}
Mục tiêu đề tài không chỉ thu thập và phân tích mà còn chia sẻ dữ liệu. Để làm được điều đó thì cần phải có API cung cấp cho những nhà phát triển thứ 3, có thể dùng API được cung cấp để sử dụng dữ liệu để phát triển. Bởi vì vậy hệ thống có xây dựng hệ thống API mở.

\subsubsection*{API List}
Ở bảng \ref{table: apilist}, hệ thống cung cấp các API về quản lý và truy vấn dữ liệu của các sensor node. Sử dụng hai method POST và GET để gửi request tới Server. 

\begin{table}[H]
	\centering
	\caption{Bảng API tương tác với dữ liệu về các node}
	\begin{tabular}{|l|l|l|l|}
		\hline
		Method & URL            & Miêu tả         & Yêu cầu xác thực người dùng        \\ \hline
		POST   & /node/initnew       & Khởi tạo node mới                & Có           \\ \hline
		POST   & /node/updatenode     & Cập nhật thông tin node & Có \\ \hline
		POST   & /node/replacenode       & Thay thế node  & Có       \\ \hline
		GET   & /node/pushdata & Push dữ liệu               &         Không                \\ \hline
		GET   & /node/getdata    & Get dữ liệu thu thập của node         &  Không      \\ \hline
		GET   & /node/getinfo   & Get thông tin của node & Không  \\ \hline
	\end{tabular}
	\label{table: apilist}
\end{table}


\subsection{Các ràng buộc của hệ thống}
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
\subsection{Mô hình ứng dụng trình bày dữ liệu}
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
\section{Hiện thực Node cảm biến}
\subsection{Các node cảm biến thu thập dữ liệu}
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
\subsection{Ứng dụng theo dõi dữ liệu và đánh giá}
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
\section{Hệ thống Server lưu trữ dữ liệu và cung cấp API}
Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
\subsection{Cấu trúc tổ chức tập tin}
\subsubsection*{Các thư mục và chức năng}
Chúng ta có những thư mục được làm việc trực tiếp:

• libs: chứa các hàm function hỗ trợ về xác thực và log.

• models: thư mục này bao gồm các mô hình quản lý cơ sở dữ liệu.

• routes: điều khiển và điều hướng theo các url.

• log: chứa các file ghi lại log trong quá trình hoạt động.

• views: là bộ mặt của web server, giúp người dùng có thể tương tác được với server qua web browser, bao gồm các file giao diện như html, ejs...   


\subsubsection*{Các file khởi tạo và cấu hình Server}

\textbf{Các file khởi tạo này bao gồm:}

• emap.js: file có chức năng đọc file cấu hình và khởi tạo kết nối server.
\begin{lstlisting}[caption=emap.js]
...
server.on('listening', onListening); // open for listening
function onListening() {
	var addr = server.address();
	var bind = typeof addr === 'string' ?
	'pipe' + addr :
	'port' + addr.port;
	debug('Listening on ' + bind);
	console.log('Listening on ' + bind);
};
...
\end{lstlisting}

• app.js: là file điều khiển và thiết lập các chức năng, khai báo các modules chính được sử dụng. Bên cạnh đó, còn có chức năng gán điều hướng tới các file trong thư mục route
\begin{lstlisting}[caption=app.js]
...
// initial server
app.use(passport.initialize());
app.use(passport.session());
app.set('views', path.join(\_\_dirname, 'views'));
app.engine('ejs', engine);
...
// control route
app.use(logger('dev'));
app.use('/log', express.static(path.join(__dirname, 'log')));
app.use(express.static(path.join(__dirname, 'public')));
app.use('/log', serveIndex('./log'));
app.use('/', routes);
app.use('/user', user);
app.use('/node', node);
app.use('/auth', auth);
...
\end{lstlisting}

\textbf{Các file cấu hình này bao gồm:}

• package.json: khai báo các thông tin cơ bản về project và các modules được sử dụng.
\begin{lstlisting}[caption=package.json]
{
	"name": "emap-server",
	"version": "1.0.0",
	"description": "This is serverside part of IoT project",
	"main": "emap.js",
	"author": "Cuong, Tung and Ny",
	"license": "ISC",
	"homepage": "www.codingyourfuture.com",
	"dependencies": {			// dependancies modules
		"angular-chart.js": "^1.0.3",
		"asyncawait": "^1.0.6",
		"babel": "^6.5.2",
		"ejs": "^2.5.2",
		...
		"rethinkdb": "^2.3.3",
		"serve-index": "^1.8.0",
		"socket.io": "^1.5.0",
	}
}
\end{lstlisting}
• config.json: khai báo các thông số cấu hình được sử dụng. Tại đây ta cấu hình thông số kết nối tới RethinkDB và port ứng dụng server nodejs.
\begin{lstlisting}[caption=config.json]
{
	"app":{
		"port": "8888"
	},
	"rethinkdb":{
		"host": "localhost",
		"port" : "28015",
		"db": "emap",
		"address":"localhost:28015",
		"tableList":["nodeData"]
	}
}

\end{lstlisting}


%% Thiết kế API



\subsection{Xây dựng Database}
% TODO: node cảm biến hay sensor node?
Hệ quản lý cơ sở dữ liệu được sử dụng tại hệ thống là RethinkDB như mô hình thiết kế hệ thống tại mục \ref{sec: struc} . Cơ sở dữ liệu được chia làm 3 bảng: nodeList, nodeData và user được miêu tả tại các hình \ref{fig: dbnode} và\ref{fig: dbuser}

Các dữ liệu về node được chia làm hai bảng:

• nodeList: chứa các thông tin về các sensor node, trong đó data\_id đóng vai trò tương tự như foreign key của bảng nodeData để có thể truy xuất dữ liệu.

• nodeData: tập trung những dữ liệu thu thập được từ các sensor node theo thời gian thực. 
\begin{figure}[H]
	\centering    
	\includegraphics[width=1.0\textwidth]{dbnode}
	\caption[Mô hình cấu trúc dữ liệu của Sensor Node]{Mô hình cấu trúc dữ liệu của Sensor Node}
	\label{fig: dbnode}
\end{figure}
Về phía user, chỉ có một bảng quản lý người dùng bao gồm các thông tin cơ bản để xác thực và quyền thay đổi chỉnh sửa dữ liệu sensor node.
\begin{figure}[H]
	\centering    
	\includegraphics[width=0.45\textwidth]{dbuser}
	\caption[Mô hình cấu trúc dữ liệu của User]{Mô hình cấu trúc dữ liệu của User}
	\label{fig: dbuser}
\end{figure}

Vì mục hệ thống phát triển dừng ở mức xây dựng và thiết kế hệ thống thu thập và truy vấn dữ liệu từ các sensor node nên chưa có bảng phân quyền sở hữu giữa người dùng và sensor node.
\subsection{Hiện thực API}
Dựa trên mô hình thiết kế API tại \ref{sec: api}, API được hiện thực và phát triển.


\subsubsection*{API đăng ký và xác thực người dùng}
Sử dụng session để quả
\subsubsection*{API cung cấp và quản lý sensor node}
Các API được miêu tả tại bảng \ref{table: apilist}, các request và respond được miêu tả chi tiết:

• API thiết lập và cấu hình các sensor node: initnew, updatenode và replace node yêu cầu phải có đăng nhập từ API xác thực người dùng để giữ session và sau đó mới có thể sử dụng. Các API này có cấu trúc tương tự nhau và được mô tả:
\begin{lstlisting}
POST: /node/initnew
data: {node\_id,lat,lng,phone,status}
======================
RESPOND:
case Success:
	{
		code: 1,
		message: 'Add node successful'
	}
case Duplicated:
	{
		code: 0,
		message: 'Node duplicated'
	}
case Failure:
	{
		code: 0,
		message: 'Add node failure'
	}
case Not authenticated:
	{
		code: -1,
		message: 'You are not authenticated'
	}
\end{lstlisting}

• API get thông tin và dữ liệu các sensor node: sử dụng phương thức GET để truy xuất dữ liệu về thông tin sensor node và dữ liệu các cảm biến. Hệ thống được thiết kế mang tính mở và chia sẻ nên không yêu cầu đăng nhập để truy xuất dữ liệu. Các thông tin đặc tả chi tiết API:
\begin{lstlisting}
GET:	/node/getinfo?*query
Ex: 	/node/getinfo?id=1&status=0
		/node/getinfo?list=1&status=1
Query:
+ id=*node ID* to get by ID
+ phone: *node phonenumber* to get by phone number
+ list=1 to get list
+ status=1 to get active node info recode, 0 to get all nodes history, showing disable nodes
======================
RESPOND:
data:
- single node:{node_id,location:{lat,lng},phone,,time,data_id,status}
- list: array of {node_id,location:{lat,lng},phone,time,data_id,status}
\end{lstlisting}

• API push dữ liệu từ sensor node: cũng tương tự như API get dữ liệu, API push dữ liệu sử dụng method GET thay cho POST để hỗ trợ dễ dàng trong việc thiết lập các thiết bị IoT đóng góp dữ liệu. Lượng dữ liệu của các sensor node không quá lớn, chỉ bao gồm những trường sensor ID và node ID nên có thể tích hợp vào thanh header của request.

\begin{lstlisting}
GET: 	/node/pushdata?*query
Ex: 	/node/pushdata?node_id=1&s1=22&s2=33&s3=44&s4=55&s5=66
Query:
+ node_id: node ID
+ s1,s2,s4,s5: value of each sensor
======================
RESPOND:
case Success:
	{
		code: 1,
		message: 'Add node data successful'
	}
case Failure:	
	{
		code: 0,
		message: 'Add node data failure'
	}
\end{lstlisting}
Giao thức được lựa chọn sử dụng trong việc push data là giao thức HTTP mà không phải các giao thức thuần để phát triển IoT như MQTT hay CoAp vì tính phổ biến và dễ thiết lập sử dụng. Chỉ cần thiết lập chuỗi URL có đính kèm thông tin là có thể hòa nhập với hệ thống mà không cần thiết lập gì thêm, có thể ví như là "plug and play" vì quá đơn giản. Bù lại, so với các giao thức tối ưu dung lượng gói tin cho phát triển IoT như MQTT, gói tin gửi qua HTTP có dung lượng nhiều hơn đáng kể nhưng với tần số hoạt động truyền dữ liệu của đề tài thì vẫn có thể chấp nhận được và không tạo ra sự khác biệt lớn khi hoạt động.
\subsubsection*{Cung cấp API log}

Để hỗ trợ bên nhà phát triển thứ ba ứng dụng API tốt hơn, hệ thống có cung cấp các thông tin hoạt động của server, các request và respond cũng như các dữ liệu được truy vấn. Khi truy cập vào đường dẫn /log/, chúng ta sẽ có những file log tương ứng với các ngày như hình \ref{fig: log} :

\begin{figure}[H]
	\centering    
	\includegraphics[width=1.0\textwidth]{log}
	\caption[Hiển thị các file log]{Hiển thị các file log}
	\label{fig: log}
\end{figure}

Ví dụ cụ thể của một đoạn log:
\begin{lstlisting}
{"level":"info","message":"IP:123.151.42.61 GET /route","timestamp":"10:48:56"}
{"level":"info","message":"IP:14.161.14.94 GET /static route","timestamp":"10:49:22"}
{"level":"info","message":"IP:14.161.14.94 GET /graph route","timestamp":"10:49:27"}
{"level":"info","message":"IP:14.161.14.94 GET /node/getinfo: get list node info - number of nodes 12","timestamp":"10:49:27"}
{"level":"info","message":"IP:14.161.14.94 GET /node/getinfo: get node info by id:9","timestamp":"10:49:29",{"data_id":"106c59fe-753d-4a76-8418-88fd0df68d0c","id":"87b7f859-8c1e-4608-9645-5105ebb38e9b", "location":{"lat":10.91085286140159,"lng":106.99790954589844}, "node_id":"9","phone":"0123456899","status":1,"time":"2016-12-06T02:08:57.943Z"}}
{"level":"info","message":"IP:14.161.14.94 GET /node/getdata: Node data ID 9 number of records:  120","timestamp":"10:49:29"}
\end{lstlisting}

Các thông tin được thể hiện trong file log đủ thông tin để cho phép nhà phát triển theo dõi và áp dụng trong việc hiện thực sản phẩm.
\subsection{Xây dựng Web Server}
\subsection*{Chức năng}

\subsubsection*{Đối với người dùng:}
Hiện thị các node cảm biến đang hoạt động trên google map, cung cấp các thông tin liên quan đến node( vị trí địa lí, tình trạng hoạt động, biểu đồ theo thời gian thực của các dữ liệu mà node thu thập được), giao tiếp với người quản lý thông qua gmail.
\subsubsection*{Đối với người quản trị:}
Bao gồm các chức năng tương tự như người dùng và thêm việc quản lý chỉnh sửa thông tin của các node: thêm, xóa, cập nhật, thay đổi…

\subsection*{Biểu đồ High level Usecase }

\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=0.7\textwidth]{usecase_diagram}
\caption[Biểu đồ High level Usecase]{Biểu đồ High level Usecase }
\label{fig:usecase_diagram}
\end{figure}
\end{center}

Mô tả giản đồ Usecase

\begin{table}[H]
\centering
\caption{Bảng mô tả giản đồ Usecase của Web Server}
\label{my-label}
\begin{tabular}{|l|l|l|}
\hline
STT & Tên            & Miêu tả                                                                                            \\ \hline
1   & View map       & Người dùng thấy được các node đang chạy trên google maps                                           \\ \hline
2   & View Node Info & Thông tin tương ứng của Node( Lat, Lng, Phone)                                                     \\ \hline
3   & View Graph     & \begin{tabular}[c]{@{}l@{}}Đồ thị hoạt động của Node(các số liệu đo được theo\\ ngày)\end{tabular} \\ \hline
4   & Contact        & Phản hồi ý kiến người dùng qua Gmail                                                               \\ \hline
5   & Add Node       & Thêm mới Node vào hoạt động                                                                        \\ \hline
6   & Update Node    & Thay đổi thông tin của Node( Lat, Lng, Phone)                                                      \\ \hline
7   & Replace Node   & Thay đổi 1 Node xảy ra sự cố bằng 1 Node khác                                                      \\ \hline
\end{tabular}
\end{table}





\subsection*{Hiện thực giao diện}

Sử dụng framework express của Nodejs và HTML để xây dựng frontend


\subsubsection*{Giao diện chính của Web Server}
Phần này chứa các nút menu chức năng cùng với google map để theo dõi vị trí hoạt động của các cảm biến.
\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=1\textwidth]{webserver}
\caption[Giao diện chính của Web Server]{Giao diện chính của Web Server}
\label{fig:webserver}
\end{figure}
\end{center}

\subsubsection*{Giao diện đồ thị dữ liệu}
Là nơi hiện thị biểu đồ của các thông số cũng như thông tin tương ứng của các cảm biến.
\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=1\textwidth]{web_graph}
\caption[Giao diện đồ thị dữ liệu]{Giao diện đồ thị dữ liệu}
\label{fig:web_graph}
\end{figure}
\end{center}



\subsubsection*{Giao diện nhận feedback từ người dùng qua email}
Tương tác giữa người dùng với người quản lý server. Nội dung được gửi thông qua gmail.
\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=1\textwidth]{web_email}
\caption[Giao diện nhận feedback người dùng]{Giao diện nhận feedback người dùng}
\label{fig:web_email}
\end{figure}
\end{center}

\subsubsection*{Giao diện dành cho người quản lý}
Khu vực này dành cho người quản lý truy cập nhầm mục đích chỉnh sửa, thay thế các node cảm biến.
\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=1\textwidth]{web_nodeinfo}
\caption[Giao diện quản lý các node cảm biến]{Giao diện quản lý các node cảm biến}
\label{fig:web_nodeinfo}
\end{figure}
\end{center}





\section{Ứng dụng thiết bị di động}

\subsection{Chức năng}
Hiện thị thông tin các node cảm biến đang hoạt động qua màn hình chính, và biểu đồ dữ liệu của từng node cảm biến theo từng ngày, thêm sự kết nối với web browser tạo sự thuận tiện cho việc theo dõi, hiện thị đồ thị (2 kiểu đồ thị là line chart và bar chart).

\subsection{Biểu đồ High level Usecase}

\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=1\textwidth]{app_usecase}
\caption[Giản đồ High level Usecase của ứng dụng di động]{Giản đồ High level Usecase của ứng dụng di động}
\label{fig:app_usecase}
\end{figure}
\end{center}



Mô tả Usecase

\begin{table}[]
\centering
\caption{Bảng mô tả giản đồ Usecase của ứng dụng di động}
\label{table:usecase_mobile}
\begin{tabular}{|l|l|l|}
\hline
STT & Tên Use-case     & Mô tả                                                            \\ \hline
1   & View Node Info   & Thông tin của Node( Lat, lng, Phone, ID)                         \\ \hline
2   & View Graph       & 2 dạng đồ thị theo ngày (line chart, bar chart của các thông số) \\ \hline
3   & Link web browser & Liên kết tới web browser                                         \\ \hline
4   & View Map         & Hiện thị Google Map và vị trí các Node                           \\ \hline
5   & Other Functions  & Các chức năng của web browser                                    \\ \hline
\end{tabular}
\end{table}


\subsection{Hiện thực giao diện và chức năng}
\subsubsection*{Giao diện chính ứng dụng di động}
Tại giao diện chính của ứng dụng di động người dùng có thể xem được danh sách thông tin chi tiết của các node cảm biến có trong hệ thống.
\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=0.4\textwidth]{app_main}
\caption[Giao diện chính ứng dụng di động]{Giao diện chính ứng dụng di động}
\label{fig:app_main}
\end{figure}
\end{center}


\subsubsection*{Giao diện xem dữ liệu trên ứng dụng di động}
Giao diện này cho phép người dùng theo dõi được dữ liệu của từng node cảm biến theo 2 loại biểu đồ như Hình \ref{fig:app_graph} thể hiện.
\begin{center}
\begin{figure}[htp]
\centering    
\includegraphics[width=0.4\textwidth]{app_graph}
\caption[Giao diện xem dữ liệu trên ứng dụng di động]{Giao diện xem dữ liệu trên ứng dụng di động}
\label{fig:app_graph}
\end{figure}
\end{center}


